<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>טופס דיווח חדש</title>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX compilation directly in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Firebase Libraries - Initialized here and exposed globally -->
    <script type="module">
        // Import Firebase functions (These must be standard ES module imports in this block)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment (do not modify these directly)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Fallback for myFirebaseConfig if __firebase_config is empty or not provided
        const myFirebaseConfig = {
            apiKey: "AIzaSyA38-uZwniXXCCK954yjcICl56mwVXbHDk",
            authDomain: "ateam-3cf3d.firebaseapp.com",
            projectId: "ateam-3cf3d",
            storageBucket: "ateam-3cf3d.firebasestorage.app",
            messagingSenderId: "760383317284",
            appId: "1:760383317284:web:a33ae7d2a89911b77f3fb1",
            measurementId: "G-NCVXFH3R6X"
        };
        
        let finalFirebaseConfig = Object.keys(firebaseConfig).length > 0 ? firebaseConfig : myFirebaseConfig;
        if (Object.keys(finalFirebaseConfig).length === 0) {
            console.error("Firebase config is empty. Cannot initialize Firebase.");
            // Set finalFirebaseConfig to an invalid state to prevent app initialization
            finalFirebaseConfig = null; 
        }

        let app;
        let auth;
        let db;

        if (finalFirebaseConfig) {
            try {
                app = initializeApp(finalFirebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase initialized in global script for index.html.");
            } catch (error) {
                console.error("Failed to initialize Firebase in global script for index.html:", error);
                app = null;
                auth = null;
                db = null;
            }
        } else {
            console.error("Skipping Firebase initialization due to empty config.");
        }

        // Expose Firebase instances and functions globally for React to access
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.globalAppId = appId;
        window.initialAuthToken = initialAuthToken; // Expose initialAuthToken

        // Expose specific Firebase functions globally
        window.getAuthGlobal = getAuth;
        window.signInAnonymouslyGlobal = signInAnonymously;
        window.signInWithCustomTokenGlobal = signInWithCustomToken;
        window.onAuthStateChangedGlobal = onAuthStateChanged;
        window.signOutFirebaseGlobal = signOut;
        window.collectionFirebaseGlobal = collection;
        window.addDocFirebaseGlobal = addDoc;
        window.docFirebaseGlobal = doc;
        window.setDocFirebaseGlobal = setDoc;
        window.getDocFirebaseGlobal = getDoc; // Corrected to use getDocFirebaseGlobal
        window.queryFirebaseGlobal = query;
        window.whereFirebaseGlobal = where;
        window.getDocsFirebaseGlobal = getDocs;
    </script>

    <style>
        /* General styles */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for scrolling content */
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            direction: rtl; /* RTL support for the entire body */
        }

        /* Container for forms/pages */
        .container {
            background-color: #ffffff;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 900px; /* Base max-width */
            box-sizing: border-box;
            text-align: right; /* RTL alignment */
            margin: 0 auto;
        }

        /* Responsive adjustments for container */
        @media (min-width: 1200px) { /* On medium-large screens, allow wider */
            .container {
                max-width: 1200px; 
            }
        }
        @media (min-width: 1600px) { /* On very large screens, allow even wider */
            .container {
                max-width: 1400px; 
            }
        }
        @media (max-width: 768px) {
            .container {
                padding: 16px;
                border-radius: 0;
                box-shadow: none;
            }
        }

        h1 {
            text-align: center;
            color: #333333;
            margin-bottom: 24px;
            font-size: 1.8em;
            font-weight: bold;
        }

        /* Form group styling */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Default 2 columns on medium, fills as needed */
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (min-width: 1200px) { /* 3 columns on larger screens */
            .form-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (min-width: 1600px) { /* 4 columns on very large screens */
            .form-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        @media (max-width: 600px) { /* Single column on small mobile */
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            text-align: right; /* RTL alignment for label and input */
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 0.95em;
        }

        .form-group label.required::after {
            content: ' *';
            color: #F44336;
            font-weight: bold;
            margin-right: 2px;
        }

        .form-group input[type="text"],
        .form-group input[type="tel"],
        .form-group input[type="email"],
        .form-group textarea,
        .form-group select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            color: #333;
            box-sizing: border-box;
            width: 100%; /* Ensure full width */
            direction: rtl; /* Ensure input text is RTL */
            text-align: right;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .form-group textarea.large-notes {
            min-height: 120px;
        }

        .form-group select {
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23333333" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18px" height="18px"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: left 10px center; /* Position arrow to the left for RTL */
            padding-left: 30px; /* Space for the arrow */
        }

        /* Error styling for form fields */
        .form-group.error input,
        .form-group.error textarea,
        .form-group.error select {
            border-color: #e74c3c; /* Red border for errors */
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.85em;
            margin-top: 5px;
            text-align: right;
        }

        .info-message {
            color: #555;
            font-size: 0.85em;
            margin-top: 5px;
            text-align: right;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        }

        .action-button {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: none;
            text-decoration: none; /* For anchor tags */
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px; /* Space between icon and text */
        }
        .action-button:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
        }
        .action-button:active {
            transform: translateY(0);
        }
        .action-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .action-button.secondary {
            background-color: #ffffff;
            color: #666666;
            border: 1px solid #dddddd;
        }
        .action-button.secondary:hover {
            background-color: #f0f0f0;
            color: #333333;
        }

        .action-button.danger {
            background-color: #e74c3c;
            color: white;
        }
        .action-button.danger:hover {
            background-color: #c0392b;
        }

        .message-box {
            background-color: #f8f8f8;
            color: #333333;
            padding: 12px;
            border: 1px solid #cccccc;
            border-radius: 6px;
            margin-top: 16px;
            margin-bottom: 16px;
            text-align: right;
            font-size: 0.9em;
            font-weight: normal;
        }
        .message-box.success {
            background-color: #e6ffe6;
            color: #2e7d32;
            border-color: #a3e6a3;
        }
        .message-box.danger {
            background-color: #ffe6e6;
            color: #c62828;
            border-color: #e6a3a3;
        }
        .message-box.warning {
            background-color: #fff3e0;
            color: #ff8f00;
            border-color: #ffd699;
        }

        /* Loading spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Section dividers */
        .section-divider {
            border-top: 1px solid #eee;
            margin: 30px 0;
        }

        /* New styles for interviewer panel */
        .interviewer-panel {
            background-color: #e9f5ff; /* Light blue background */
            border: 1px solid #cce7ff;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 25px;
            text-align: right;
            display: flex;
            flex-direction: column; /* Stack elements vertically */
            align-items: flex-end; /* Align to the right */
        }

        .interviewer-display {
            display: flex;
            align-items: center;
            justify-content: flex-end; /* Align greeting to the right */
            width: 100%;
            font-size: 1.1em;
            font-weight: bold;
            color: #2c3e50;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 10px; /* Space between elements */
        }

        .interviewer-display span {
            white-space: nowrap; /* Prevent name/UID from wrapping */
        }

        .interviewer-edit-area {
            width: 100%;
        }

        .interviewer-edit-area h3 {
            text-align: center;
            color: #3498db;
            margin-top: 10px;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .interviewer-inputs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        @media (max-width: 600px) {
            .interviewer-inputs-grid {
                grid-template-columns: 1fr;
            }
        }
        .small-button {
            padding: 8px 15px;
            font-size: 0.85em;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Function to validate Israeli ID Number using the checksum algorithm
        function validateIsraeliId(id) {
            id = String(id).trim();
            if (id.length > 9 || !/^\d+$/.test(id)) {
                return false;
            }

            id = id.padStart(9, '0'); // Pad with leading zeros if less than 9 digits

            let sum = 0;
            for (let i = 0; i < 9; i++) {
                let digit = parseInt(id[i], 10);
                if (i % 2 === 0) { // Odd positions (0, 2, 4, 6, 8) - multiply by 1
                    sum += digit;
                } else { // Even positions (1, 3, 5, 7) - multiply by 2
                    let doubled = digit * 2;
                    sum += (doubled > 9) ? (doubled - 9) : doubled;
                }
            }
            return (sum % 10 === 0);
        }

        // Main Form Component
        function QuestionnaireForm({ auth, db, userUid, onLogout }) {
            // States for Interviewer Details (stored locally)
            const [interviewerFirstName, setInterviewerFirstName] = useState(() => localStorage.getItem('interviewerFirstName') || '');
            const [interviewerFamilyName, setInterviewerFamilyName] = useState(() => localStorage.getItem('interviewerFamilyName') || '');
            const [interviewerUidSaved, setInterviewerUidSaved] = useState(() => localStorage.getItem('interviewerUid') || '');
            
            // State to control visibility of interviewer details input fields
            const [isInterviewerDetailsEditable, setIsInterviewerDetailsEditable] = useState(
                !localStorage.getItem('interviewerFirstName') || !localStorage.getItem('interviewerFamilyName')
            ); // Initially editable if names are missing in localStorage

            // States for Reporter Details (the person being reported)
            const [firstName, setFirstName] = useState('');
            const [familyName, setFamilyName] = useState('');
            const [idNumber, setIdNumber] = useState('');
            const [phoneNumber, setPhoneNumber] = useState('');
            const [protectedSpaceStatus, setProtectedSpaceStatus] = useState('');
            const [protectedSpaceDetails, setProtectedSpaceDetails] = useState('');
            const [comments, setComments] = useState('');

            // Validation states for form fields
            const [interviewerFirstNameError, setInterviewerFirstNameError] = useState(false);
            const [interviewerFamilyNameError, setInterviewerFamilyNameError] = useState(false);
            const [firstNameError, setFirstNameError] = useState(false);
            const [familyNameError, setFamilyNameError] = useState(false);
            const [idNumberError, setIdNumberError] = useState(false);
            const [phoneNumberError, setPhoneNumberError] = useState(false);
            const [protectedSpaceStatusError, setProtectedSpaceStatusError] = useState(false);
            const [protectedSpaceDetailsError, setProtectedSpaceDetailsError] = useState(false);
            const [commentsError, setCommentsError] = useState(false);

            // General form states
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');
            const [duplicateIdInfo, setDuplicateIdInfo] = useState(null); // State for duplicate ID info

            // Reference to setTimeout for debouncing ID check
            const debounceTimeoutRef = useRef(null);

            // Function to set message and clear it after a delay
            const showMessage = (text, type = 'default') => {
                setMessage(text);
                setMessageType(type);
                setTimeout(() => {
                    setMessage('');
                    setMessageType('');
                }, 5000); // Message disappears after 5 seconds
            };

            // Load interviewer details from localStorage on component mount
            useEffect(() => {
                const storedFirstName = localStorage.getItem('interviewerFirstName');
                const storedFamilyName = localStorage.getItem('interviewerFamilyName');
                const storedUid = localStorage.getItem('interviewerUid');
                if (storedFirstName) setInterviewerFirstName(storedFirstName);
                if (storedFamilyName) setInterviewerFamilyName(storedFamilyName);
                if (storedUid) setInterviewerUidSaved(storedUid); // Set saved UID if available
            }, []);

            // Save interviewer details to localStorage when userUid, firstName or familyName changes
            useEffect(() => {
                if (userUid) { // Ensure userUid is available before saving anything to localStorage
                    localStorage.setItem('interviewerFirstName', interviewerFirstName);
                    localStorage.setItem('interviewerFamilyName', interviewerFamilyName);
                    localStorage.setItem('interviewerUid', userUid);
                    setInterviewerUidSaved(userUid); // Update local state for display
                }
            }, [interviewerFirstName, interviewerFamilyName, userUid]);


            // Effect to check for duplicate ID numbers when idNumber changes
            useEffect(() => {
                // Clear any previous debounce timeout
                if (debounceTimeoutRef.current) {
                    clearTimeout(debounceTimeoutRef.current);
                }

                const trimmedId = idNumber.trim();
                // Only check if ID is valid (9 digits, passes checksum) and Firebase is initialized
                if (trimmedId && trimmedId.length === 9 && /^\d+$/.test(trimmedId) && validateIsraeliId(trimmedId) && db) {
                    setDuplicateIdInfo(null); // Clear previous duplicate info while typing/validating

                    debounceTimeoutRef.current = setTimeout(async () => {
                        try {
                            const formDataCollection = window.collectionFirebaseGlobal(db, `artifacts/${window.globalAppId}/public/data/formData`);
                            const q = window.queryFirebaseGlobal(
                                formDataCollection,
                                window.whereFirebaseGlobal('idNumber', '==', trimmedId)
                            );
                            const querySnapshot = await window.getDocsFirebaseGlobal(q);

                            let duplicateFound = null;
                            if (!querySnapshot.empty) {
                                // If a document with this ID is found, set duplicate info
                                const docSnap = querySnapshot.docs[0]; // Take the first one found
                                const data = docSnap.data();
                                duplicateFound = {
                                    timestamp: data.timestamp,
                                    interviewerFirstName: data.interviewerFirstName,
                                    interviewerFamilyName: data.interviewerFamilyName
                                };
                            }
                            setDuplicateIdInfo(duplicateFound);

                        } catch (error) {
                            console.error("Error checking duplicate ID:", error);
                            setDuplicateIdInfo(null);
                            // It's a non-critical check, so don't show a general error message to user
                        }
                    }, 500); // Debounce by 500ms
                } else {
                    setDuplicateIdInfo(null); // Clear duplicate info if ID is invalid or empty
                }

                // Cleanup on unmount or idNumber change
                return () => {
                    if (debounceTimeoutRef.current) {
                        clearTimeout(debounceTimeoutRef.current);
                    }
                };
            }, [idNumber, db]); // Only re-run if idNumber or db changes

            // Handles form validation
            const validateForm = () => {
                let isValid = true;

                // Reset all errors
                setInterviewerFirstNameError(false);
                setInterviewerFamilyNameError(false);
                setFirstNameError(false);
                setFamilyNameError(false);
                setIdNumberError(false);
                setPhoneNumberError(false);
                setProtectedSpaceStatusError(false);
                setProtectedSpaceDetailsError(false);
                setCommentsError(false);

                // Validate interviewer details FIRST
                if (!interviewerFirstName.trim()) {
                    setInterviewerFirstNameError(true);
                    isValid = false;
                    setIsInterviewerDetailsEditable(true); // Force open if details are missing
                }
                if (!interviewerFamilyName.trim()) {
                    setInterviewerFamilyNameError(true);
                    isValid = false;
                    setIsInterviewerDetailsEditable(true); // Force open if details are missing
                }
                if (!interviewerFirstName.trim() || !interviewerFamilyName.trim()) {
                    showMessage('אנא מלא את פרטי המראיין (שם ושם משפחה).', 'danger');
                    return false; // Exit early if interviewer details are missing
                }


                // Validate citizen details
                if (!firstName.trim()) {
                    setFirstNameError(true);
                    isValid = false;
                }
                if (!familyName.trim()) {
                    setFamilyNameError(true);
                    isValid = false;
                }
                
                const trimmedId = idNumber.trim();
                if (!trimmedId || !/^\d{9}$/.test(trimmedId)) {
                    setIdNumberError(true);
                    isValid = false;
                } else if (!validateIsraeliId(trimmedId)) {
                    setIdNumberError(true);
                    isValid = false;
                }

                if (!phoneNumber.trim()) {
                    setPhoneNumberError(true);
                    isValid = false;
                } else if (!/^\d{9,10}$/.test(phoneNumber.trim())) {
                    setPhoneNumberError(true);
                    isValid = false;
                }

                if (!protectedSpaceStatus) {
                    setProtectedSpaceStatusError(true);
                    isValid = false;
                } else if ((protectedSpaceStatus === 'no' || protectedSpaceStatus === 'not_sure') && !protectedSpaceDetails.trim()) {
                    setProtectedSpaceDetailsError(true);
                    isValid = false;
                }

                if (comments.length > 50) {
                    setCommentsError(true);
                    isValid = false;
                }

                return isValid;
            };

            // Handles form submission
            const handleSubmit = async (e) => {
                e.preventDefault(); // Prevent default form submission
                setMessage(''); // Clear previous messages
                setMessageType('');
                
                if (!db) {
                    showMessage('שגיאה: שירותי Firebase Database אינם זמינים.', 'danger');
                    return;
                }
                if (!userUid) {
                    showMessage('שגיאה: אינך מחובר. אנא נסה לרענן את הדף.', 'danger');
                    return;
                }

                if (!validateForm()) {
                    // Message already set by validateForm
                    return;
                }

                // If a duplicate ID is found, show a warning and potentially prevent submission
                if (duplicateIdInfo) {
                    showMessage('אזהרה: תעודת זהות זו כבר קיימת במערכת. אם אתה בטוח שזהו דיווח חדש, לחץ "שלח דיווח" שוב כדי לאשר.', 'warning');
                    // This allows a double-click to submit despite warning
                    setDuplicateIdInfo(null); // Clear to allow re-submission
                    return; 
                }

                setLoading(true);
                try {
                    // Save interviewer details to profile (if they don't exist or need update)
                    // This also serves as a check that interviewer details are valid and present
                    const interviewerProfileRef = window.docFirebaseGlobal(db, `artifacts/${window.globalAppId}/users/${userUid}/profile/details`);
                    const interviewerProfileSnap = await window.getDocFirebaseGlobal(interviewerProfileRef);

                    if (!interviewerProfileSnap.exists() || interviewerProfileSnap.data().firstName !== interviewerFirstName || interviewerProfileSnap.data().familyName !== interviewerFamilyName) {
                        await window.setDocFirebaseGlobal(interviewerProfileRef, {
                            firstName: interviewerFirstName.trim(),
                            familyName: interviewerFamilyName.trim(),
                            uid: userUid,
                            lastUpdated: Date.now()
                        }, { merge: true }); // Use merge to avoid overwriting other fields
                    }

                    // Save form data to the PUBLIC collection
                    const formDataCollectionRef = window.collectionFirebaseGlobal(db, `artifacts/${window.globalAppId}/public/data/formData`);
                    await window.addDocFirebaseGlobal(formDataCollectionRef, {
                        interviewerUid: userUid,
                        interviewerFirstName: interviewerFirstName.trim(),
                        interviewerFamilyName: interviewerFamilyName.trim(),
                        firstName: firstName.trim(),
                        familyName: familyName.trim(),
                        idNumber: idNumber.trim(),
                        phoneNumber: phoneNumber.trim(),
                        protectedSpaceStatus: protectedSpaceStatus,
                        protectedSpaceDetails: protectedSpaceDetails.trim(),
                        comments: comments.trim(),
                        timestamp: Date.now() // Record submission time
                    });

                    showMessage('הדיווח נשלח בהצלחה!', 'success');
                    // Clear the form fields after successful submission (except interviewer details)
                    setFirstName('');
                    setFamilyName('');
                    setIdNumber('');
                    setPhoneNumber('');
                    setProtectedSpaceStatus('');
                    setProtectedSpaceDetails('');
                    setComments('');
                    setDuplicateIdInfo(null); // Clear any remaining duplicate ID warning
                } catch (error) {
                    console.error("Error adding document:", error);
                    let errorMessage = `שגיאה בשליחת הדיווח: ${error.message}.`;
                    if (error.code === 'permission-denied') {
                        errorMessage += " וודא שכללי האבטחה של Firestore מאפשרים כתיבה לקולקציית 'formData' הציבורית ועדכון פרופיל המראיין.";
                    }
                    showMessage(errorMessage, 'danger');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="container">
                    <div className="button-container" style={{ justifyContent: 'flex-end', marginBottom: '20px' }}>
                        <a href="data.html" className="action-button secondary">
                            <i className="fas fa-list"></i> צפה בכל הדיווחים
                        </a>
                        <button onClick={onLogout} className="action-button danger">
                            <i className="fas fa-sign-out-alt"></i> התנתק
                        </button>
                    </div>

                    <h1 style={{marginTop: '0'}}>טופס דיווח חדש לאזרח</h1>
                    
                    {/* Interviewer Panel - Displayed subtly at the top */}
                    <div className="interviewer-panel">
                        {interviewerFirstName && interviewerFamilyName && !isInterviewerDetailsEditable ? (
                            <div className="interviewer-display">
                                <span>שלום {interviewerFirstName} {interviewerFamilyName}</span>
                                <span style={{ fontSize: '0.8em', color: '#888', marginRight: '10px' }}> (UID: {interviewerUidSaved || userUid || 'טוען...'})</span>
                                <button type="button" className="action-button secondary small-button" onClick={() => setIsInterviewerDetailsEditable(true)}>
                                    <i className="fas fa-edit"></i> ערוך פרטים
                                </button>
                            </div>
                        ) : (
                            <div className="interviewer-edit-area">
                                <h3>פרטי מראיין (נדרש למילוי חד פעמי)</h3>
                                <div className="interviewer-inputs-grid">
                                    <div className={`form-group ${interviewerFirstNameError ? 'error' : ''}`}>
                                        <label htmlFor="interviewerFirstName" className="required">שם פרטי:</label>
                                        <input
                                            type="text"
                                            id="interviewerFirstName"
                                            value={interviewerFirstName}
                                            onChange={(e) => { setInterviewerFirstName(e.target.value); setInterviewerFirstNameError(false); }}
                                            placeholder="הזן שם פרטי"
                                            required
                                        />
                                        {interviewerFirstNameError && <p className="error-message">שם פרטי נדרש.</p>}
                                    </div>
                                    <div className={`form-group ${interviewerFamilyNameError ? 'error' : ''}`}>
                                        <label htmlFor="interviewerFamilyName" className="required">שם משפחה:</label>
                                        <input
                                            type="text"
                                            id="interviewerFamilyName"
                                            value={interviewerFamilyName}
                                            onChange={(e) => { setInterviewerFamilyName(e.target.value); setInterviewerFamilyNameError(false); }}
                                            placeholder="הזן שם משפחה"
                                            required
                                        />
                                        {interviewerFamilyNameError && <p className="error-message">שם משפחה נדרש.</p>}
                                    </div>
                                    <div className="form-group">
                                        <label>UID מראיין:</label>
                                        <input type="text" value={interviewerUidSaved || userUid || 'טוען...'} readOnly />
                                        <p className="info-message">מזהה זה משמש לזיהויך במערכת.</p>
                                    </div>
                                </div>
                                {(interviewerFirstName.trim() && interviewerFamilyName.trim()) && (
                                    <button type="button" className="action-button secondary small-button" onClick={() => {
                                        setIsInterviewerDetailsEditable(false);
                                    }}>
                                        <i className="fas fa-check"></i> אישור פרטים
                                    </button>
                                )}
                            </div>
                        )}
                    </div> {/* End of interviewer-panel */}


                    {message && <div className={`message-box ${messageType}`}>{message}</div>}

                    <form onSubmit={handleSubmit}>
                        <h2>פרטי האזרח המדווח</h2>
                        <div className="form-grid">
                            <div className={`form-group ${firstNameError ? 'error' : ''}`}>
                                <label htmlFor="firstName" className="required">שם פרטי:</label>
                                <input
                                    type="text"
                                    id="firstName"
                                    value={firstName}
                                    onChange={(e) => { setFirstName(e.target.value); setFirstNameError(false); }}
                                    placeholder="הזן שם פרטי של האזרח"
                                    required
                                />
                                {firstNameError && <p className="error-message">שם פרטי נדרש.</p>}
                            </div>
                            <div className={`form-group ${familyNameError ? 'error' : ''}`}>
                                <label htmlFor="familyName" className="required">שם משפחה:</label>
                                <input
                                    type="text"
                                    id="familyName"
                                    value={familyName}
                                    onChange={(e) => { setFamilyName(e.target.value); setFamilyNameError(false); }}
                                    placeholder="הזן שם משפחה של האזרח"
                                    required
                                />
                                {familyNameError && <p className="error-message">שם משפחה נדרש.</p>}
                            </div>
                            <div className={`form-group ${idNumberError ? 'error' : ''}`}>
                                <label htmlFor="idNumber" className="required">תעודת זהות:</label>
                                <input
                                    type="tel"
                                    id="idNumber"
                                    value={idNumber}
                                    onChange={(e) => { setIdNumber(e.target.value.replace(/\D/g, '').slice(0, 9)); setIdNumberError(false); }}
                                    placeholder="הזן תעודת זהות (9 ספרות)"
                                    maxLength="9"
                                    required
                                />
                                {idNumberError && <p className="error-message">תעודת זהות לא תקינה (9 ספרות).</p>}
                                {duplicateIdInfo && (
                                    <p className="message-box warning" style={{ marginTop: '10px', fontSize: '0.85em', textAlign: 'right' }}>
                                        <i className="fas fa-exclamation-triangle"></i> ת.ז. זו כבר קיימת במערכת! הוגש בתאריך:{' '}
                                        {new Date(duplicateIdInfo.timestamp).toLocaleString('he-IL')} על ידי{' '}
                                        {duplicateIdInfo.interviewerFirstName} {duplicateIdInfo.interviewerFamilyName}.
                                    </p>
                                )}
                            </div>
                            <div className={`form-group ${phoneNumberError ? 'error' : ''}`}>
                                <label htmlFor="phoneNumber" className="required">טלפון:</label>
                                <input
                                    type="tel"
                                    id="phoneNumber"
                                    value={phoneNumber}
                                    onChange={(e) => { setPhoneNumber(e.target.value.replace(/\D/g, '')); setPhoneNumberError(false); }}
                                    placeholder="הזן מספר טלפון"
                                    required
                                />
                                {phoneNumberError && <p className="error-message">מספר טלפון לא תקין (9-10 ספרות).</p>}
                            </div>

                            <div className={`form-group ${protectedSpaceStatusError ? 'error' : ''}`}>
                                <label htmlFor="protectedSpaceStatus" className="required">האם המרחב המוגן תקין?</label>
                                <select
                                    id="protectedSpaceStatus"
                                    value={protectedSpaceStatus}
                                    onChange={(e) => { setProtectedSpaceStatus(e.target.value); setProtectedSpaceStatusError(false); }}
                                    required
                                >
                                    <option value="">בחר סטטוס</option>
                                    <option value="yes">כן</option>
                                    <option value="no">לא</option>
                                    <option value="not_sure">לא בטוח</option>
                                </select>
                                {protectedSpaceStatusError && <p className="error-message">בחירת סטטוס נדרשת.</p>}
                            </div>

                            {(protectedSpaceStatus === 'no' || protectedSpaceStatus === 'not_sure') && (
                                <div className={`form-group ${protectedSpaceDetailsError ? 'error' : ''}`}>
                                    <label htmlFor="protectedSpaceDetails" className="required">פירוט (למה לא תקין / לא בטוח):</label>
                                    <textarea
                                        id="protectedSpaceDetails"
                                        value={protectedSpaceDetails}
                                        onChange={(e) => { setProtectedSpaceDetails(e.target.value); setProtectedSpaceDetailsError(false); }}
                                        rows="3"
                                        placeholder="פרט מדוע המרחב המוגן אינו תקין / אינך בטוח"
                                        required
                                    ></textarea>
                                    {protectedSpaceDetailsError && <p className="error-message">פירוט נדרש עבור סטטוס זה.</p>}
                                </div>
                            )}

                            <div className={`form-group ${commentsError ? 'error' : ''}`}>
                                <label htmlFor="comments">הערות: <span style={{fontSize: '0.8em', color: '#888'}}>(עד 50 תווים)</span></label>
                                <textarea
                                    id="comments"
                                    value={comments}
                                    onChange={(e) => { setComments(e.target.value.slice(0, 50)); setCommentsError(false); }}
                                    className="large-notes"
                                    maxLength="50"
                                    placeholder="הערות נוספות"
                                ></textarea>
                                <p style={{fontSize: '0.8em', color: '#888', textAlign: 'left', marginTop: '4px'}}>
                                    {comments.length}/50 תווים
                                </p>
                                {commentsError && <p className="error-message">הערות: מקסימום 50 תווים.</p>}
                            </div>
                        </div>

                        <div className="button-container">
                            <button type="submit" className="action-button" disabled={loading}>
                                {loading ? (
                                    <div className="spinner"></div>
                                ) : (
                                    <>
                                        <i className="fas fa-paper-plane"></i> שלח דיווח
                                    </>
                                )}
                            </button>
                        </div>
                    </form>
                </div>
            );
        }

        // Main App Component (Authentication handling)
        function App() {
            const [firebaseInstances, setFirebaseInstances] = useState({ app: null, auth: null, db: null });
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userUid, setUserUid] = useState(null);
            const logoutTriggeredRef = useRef(false);

            useEffect(() => {
                // Check if Firebase instances are globally exposed and valid
                if (!window.firebaseApp || !window.firebaseAuth || !window.firebaseDb) {
                    console.error("Global Firebase instances are not available. Cannot initialize App component.");
                    // Optionally, show a message to the user that Firebase is not configured
                    // For now, it will just show the loading state indefinitely or until config is fixed.
                    return;
                }

                setFirebaseInstances({
                    app: window.firebaseApp,
                    auth: window.firebaseAuth,
                    db: window.firebaseDb
                });

                // Authenticate anonymously or with custom token
                const authenticateFirebase = async () => {
                    try {
                        const authInstance = window.firebaseAuth;
                        if (authInstance) {
                            if (window.initialAuthToken) {
                                await window.signInWithCustomTokenGlobal(authInstance, window.initialAuthToken);
                                console.log("Signed in with custom token.");
                            } else {
                                await window.signInAnonymouslyGlobal(authInstance);
                                console.log("Signed in anonymously.");
                            }
                        } else {
                            console.error("Firebase Auth instance is not available for authentication.");
                        }
                    } catch (error) {
                        console.error("Firebase authentication error:", error);
                        // Handle authentication errors, e.g., show login page or error message
                    }
                };

                // Listen for auth state changes
                const unsubscribeAuth = window.onAuthStateChangedGlobal(window.firebaseAuth, (user) => {
                    if (!logoutTriggeredRef.current) {
                        if (user) {
                            setUserUid(user.uid);
                            console.log("Auth State Changed: User is signed in with UID:", user.uid);
                        } else {
                            setUserUid(null);
                            console.log("Auth State Changed: No user is signed in.");
                            // If no user is signed in and it's not a logout, try to authenticate
                            if (!window.firebaseAuth.currentUser) {
                                authenticateFirebase();
                            }
                        }
                        setIsAuthReady(true); // Mark auth as ready once initial check is done
                    }
                });

                // Initial authentication attempt if no user is present
                if (!window.firebaseAuth.currentUser) {
                    authenticateFirebase();
                }

                return () => {
                    unsubscribeAuth(); // Clean up auth listener on unmount
                };
            }, []); // Empty dependency array means this runs once on mount

            const handleLogout = async () => {
                logoutTriggeredRef.current = true; // Set flag to prevent re-authentication immediately
                if (firebaseInstances.auth) {
                    try {
                        await window.signOutFirebaseGlobal(firebaseInstances.auth);
                        setUserUid(null);
                        localStorage.removeItem('interviewerFirstName');
                        localStorage.removeItem('interviewerFamilyName');
                        localStorage.removeItem('interviewerUid');
                        console.log("User signed out successfully.");
                        // No redirect here, QuestionnaireForm component will be rendered automatically
                    } catch (error) {
                        console.error("Error signing out:", error);
                    } finally {
                        logoutTriggeredRef.current = false; // Reset flag after logout attempt
                    }
                }
            };

            if (!isAuthReady) {
                return (
                    <div className="container" style={{ textAlign: 'center', padding: '50px' }}>
                        <h1>טוען הגדרות אבטחה...</h1>
                        <p style={{color: '#555'}}>ממתין לסטטוס הזדהות.</p>
                        <div className="spinner"></div>
                    </div>
                );
            }

            // If Firebase is initialized but no user is logged in, show a message or redirect to a more appropriate entry point
            // In this setup, we assume that signInAnonymously will eventually succeed and userUid will be populated.
            // If it fails permanently, the user will be stuck in the loading state, or an error message will be shown.
            if (!userUid) {
                 return (
                    <div className="container" style={{ textAlign: 'center', padding: '50px' }}>
                        <h1>ממתין לזיהוי המראיין...</h1>
                        <p style={{color: '#555'}}>נא המתן. אם ההודעה הזו נשארת זמן רב, ייתכן שישנה בעיה בהגדרות Firebase.</p>
                        <div className="spinner"></div>
                    </div>
                );
            }
            
            // Render the QuestionnaireForm if authenticated
            return (
                <QuestionnaireForm
                    auth={firebaseInstances.auth}
                    db={firebaseInstances.db}
                    userUid={userUid}
                    onLogout={handleLogout}
                />
            );
        }
        // Corrected React 18 rendering method
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
