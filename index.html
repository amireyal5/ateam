<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>טופס נתונים Hugo</title>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX compilation directly in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase Libraries - Initialized here and exposed globally -->
    <script type="module">
        // Import Firebase functions (These must be standard ES module imports in this block)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Note: For collectionGroup, it needs to be imported directly where used,
        // or ensure it's made globally available if needed by the React components.
        // For simplicity and to avoid 'require is not defined' issue, we will make
        // core Firestore and Auth functions globally available.
        import { getFirestore, collection, addDoc, onSnapshot, collectionGroup, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // Global variables provided by the Canvas environment (do not modify these directly)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- חובה: הדבק כאן את אובייקט ה-firebaseConfig שלך מ-Firebase Console ---
        // עליך למצוא אותו בהגדרות הפרויקט שלך ב-Firebase (Project settings -> Your apps -> Web app -> Config).
        // הוא ייראה בערך ככה:
        // const myFirebaseConfig = {
        //     apiKey: "AIzaSy...",
        //     authDomain: "your-project-id.firebaseapp.com",
        //     projectId: "your-project-id",
        //     storageBucket: "your-project-id.appspot.com",
        //     messagingSenderId: "...",
        //     appId: "1:...",
        //     measurementId: "G-..." // אם הוגדר
        // };
        const myFirebaseConfig = {
            apiKey: "AIzaSyA38-uZwniXXCCK954yjcICl56mwVXbHDk",
            authDomain: "ateam-3cf3d.firebaseapp.com",
            projectId: "ateam-3cf3d",
            storageBucket: "ateam-3cf3d.firebasestorage.app",
            messagingSenderId: "760383317284",
            appId: "1:760383317284:web:a33ae7d2a89911b77f3fb1",
            measurementId: "G-NCVXFH3R6X"
        }; // --- האובייקט שהודבק כאן הוא ה-firebaseConfig שלך ---

        let firebaseConfig;
        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config !== null && String(__firebase_config).trim() !== '') {
                const parsedConfig = JSON.parse(__firebase_config);
                if (Object.keys(parsedConfig).length > 0) {
                    firebaseConfig = parsedConfig;
                } else {
                    firebaseConfig = myFirebaseConfig;
                    console.warn("Environmental __firebase_config was empty after parsing. Falling back to hardcoded myFirebaseConfig.");
                }
            } else {
                firebaseConfig = myFirebaseConfig;
                console.log("Environmental __firebase_config not found or is empty. Using hardcoded myFirebaseConfig.");
            }
        } catch (e) {
            console.error("Error parsing __firebase_config, falling back to hardcoded config:", e);
            firebaseConfig = myFirebaseConfig;
        }

        // Initialize Firebase app and services
        let app;
        let auth;
        let db;

        try {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is empty. Cannot initialize Firebase.");
            } else {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase initialized in global script.");
            }
        } catch (error) {
            console.error("Failed to initialize Firebase in global script:", error);
            // Ensure instances are null if initialization fails
            app = null;
            auth = null;
            db = null;
        }

        // Expose Firebase instances and functions globally for React to access
        // React components will now access these via 'window.' prefix
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.globalAppId = appId; // Used for Firestore paths

        // Expose specific Firebase functions globally with distinct names
        window.onAuthStateChangedGlobal = onAuthStateChanged;
        window.signOutFirebaseGlobal = signOut; 
        window.GoogleAuthProviderFirebaseGlobal = GoogleAuthProvider; 
        window.signInWithPopupFirebaseGlobal = signInWithPopup; 
        window.collectionFirebaseGlobal = collection; 
        window.addDocFirebaseGlobal = addDoc; 
        window.onSnapshotFirebaseGlobal = onSnapshot; 
        window.collectionGroupFirebaseGlobal = collectionGroup; // New: expose collectionGroup
        window.queryFirebaseGlobal = query; // New: expose query

    </script>

    <style>
        /* הגדרות בסיסיות לגוף הדף */
        body {
            font-family: 'Inter', Arial, sans-serif; /* שימוש בפונט Inter */
            background-color: #f0f2f5; /* צבע רקע עדין */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* גובה מינימלי של 100% מגובה המסך */
            margin: 0;
            padding: 20px;
            box-sizing: border-box; /* מבטיח שריפוד וגבולות לא יגדילו את הגודל הכולל של האלמנט */
        }

        /* מכל הטופס והלוגין */
        .container {
            background-color: #ffffff; /* רקע לבן */
            padding: 35px;
            border-radius: 12px; /* פינות מעוגלות */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); /* צל עדין */
            width: 100%;
            max-width: 900px; /* רוחב מקסימלי */
            box-sizing: border-box;
            border: 1px solid #e0e0e0; /* גבול עדין */
            text-align: center;
        }

        h1 {
            text-align: center;
            color: #2c3e50; /* צבע כהה לכותרת */
            margin-bottom: 35px;
            font-size: 2.2em; /* גודל פונט גדול יותר */
            font-weight: 700; /* עובי פונט מודגש */
        }

        .form-section {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px dashed #cccccc; /* קו הפרדה מקווקו */
        }

        .form-section:last-of-type {
            border-bottom: none;
            padding-bottom: 0;
        }

        .form-grid {
            display: grid;
            gap: 25px; /* מרווח בין השדות */
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* התאמה אוטומטית של עמודות */
        }

        .form-grid.two-columns {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .form-group {
            display: flex;
            flex-direction: column;
            text-align: right; /* יישור לימין עבור RTL */
        }

        label {
            margin-bottom: 10px;
            color: #34495e; /* צבע כהה לתווית */
            font-weight: 600; /* עובי פונט בינוני */
            font-size: 1.05em;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select,
        input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #dcdcdc; /* גבול עדין */
            border-radius: 8px; /* פינות מעוגלות */
            box-sizing: border-box;
            font-size: 1.1em;
            color: #333;
            transition: border-color 0.3s ease, box-shadow 0.3s ease; /* אנימציה חלקה במעבר */
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus,
        input[type="password"]:focus {
            border-color: #3498db; /* צבע כחול בפוקוס */
            outline: none; /* הסרת קו המתאר ברירת המחדל */
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2); /* צל בפוקוס */
        }

        textarea {
            resize: vertical; /* מאפשר שינוי גודל אנכי בלבד */
            min-height: 100px; /* גובה מינימלי */
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap; /* מאפשר מעבר שורה לפריטים */
            gap: 20px; /* מרווח בין כפתורי הרדיו */
            margin-top: 8px;
        }

        .radio-group label {
            margin-bottom: 0;
            font-weight: normal; /* ביטול מודגש */
            display: flex;
            align-items: center;
            cursor: pointer; /* סמן עכבר יד */
            color: #444;
            font-size: 1em;
        }

        .radio-group input[type="radio"] {
            margin-left: 8px; /* מרווח משמאל לכפתור עבור RTL */
            width: auto;
            transform: scale(1.2); /* הגדלת גודל כפתור הרדיו */
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 15px; /* מרווח בין כפתורים */
            margin-top: 30px;
        }

        .action-button {
            background-color: #28a745; /* צבע ירוק לכפתור */
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease; /* אנימציות למעבר וריחוף */
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3); /* צל לכפתור */
        }

        .action-button.secondary {
            background-color: #007bff;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
        }

        .action-button.danger {
            background-color: #dc3545;
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
        }

        .action-button.google {
            background-color: #db4437; /* Google red */
            box-shadow: 0 4px 10px rgba(219, 68, 55, 0.3);
        }

        .action-button:hover {
            background-color: #218838; /* צבע ירוק כהה יותר בריחוף */
            transform: translateY(-2px); /* אפקט קל של ריחוף */
        }

        .action-button.secondary:hover {
            background-color: #0069d9;
        }

        .action-button.danger:hover {
            background-color: #c82333;
        }

        .action-button.google:hover {
            background-color: #c23321;
        }

        .action-button:active {
            background-color: #1e7e34; /* צבע ירוק כהה בלחיצה */
            transform: translateY(0); /* חזרה למצב רגיל בלחיצה */
        }
        .action-button.secondary:active {
            background-color: #0056b3;
        }
        .action-button.danger:active {
            background-color: #bd2130;
        }
        .action-button.google:active {
            background-color: #a72719;
        }

        .message-box {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            margin-top: 20px;
            text-align: right;
            font-size: 1em;
            font-weight: bold;
        }
        .message-box.success {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .previous-submissions {
            margin-top: 40px;
            text-align: right;
            border-top: 1px dashed #cccccc;
            padding-top: 25px;
        }
        .previous-submissions h2 {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 20px;
        }
        .submission-item {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: right;
            line-height: 1.6;
        }
        .submission-item strong {
            color: #34495e;
        }
        .submission-item span {
            display: block;
            margin-bottom: 5px;
            font-size: 0.95em;
            color: #555;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .form-grid,
            .form-grid.two-columns {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 25px;
                margin: 10px;
            }
            h1 {
                font-size: 1.8em;
                margin-bottom: 25px;
            }
            label {
                font-size: 1em;
            }
            input[type="text"],
            input[type="number"],
            textarea,
            select,
            input[type="password"] {
                padding: 10px 12px;
                font-size: 1em;
            }
            .form-section {
                margin-bottom: 20px;
                padding-bottom: 15px;
            }
            .action-button {
                padding: 12px 25px;
                font-size: 1.1em;
            }
            .previous-submissions h2 {
                font-size: 1.5em;
            }
        }
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Component for the Login Page - now only with Google login
        function LoginPage({ auth, onLoginSuccess }) {
            const [message, setMessage] = useState('');
            const [loading, setLoading] = useState(false);
            
            const handleGoogleLogin = async () => {
                setMessage('');
                setLoading(true);
                try {
                    if (!auth) {
                        setMessage('שגיאה: שירותי Firebase Auth אינם זמינים. אנא וודא את הגדרות Firebase.');
                        setLoading(false);
                        return;
                    }
                    const provider = new window.GoogleAuthProviderFirebaseGlobal(); // Access from global
                    const userCredential = await window.signInWithPopupFirebaseGlobal(auth, provider); // Access from global
                    setMessage('התחברות עם גוגל הצליחה! נא המתן...');
                    const googleIdentity = userCredential.user.email || userCredential.user.displayName || userCredential.user.uid;
                    onLoginSuccess(userCredential.user.uid, googleIdentity);
                } catch (error) {
                    console.error("Google login error:", error);
                    let errorMessage = 'שגיאה בהתחברות עם גוגל.';
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = 'התחברות עם גוגל בוטלה.';
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        errorMessage = 'בקשת התחברות עם גוגל בוטלה. אנא נסה שוב.';
                    } else if (error.code === 'auth/unauthorized-domain') {
                        errorMessage = 'דומיין לא מורשה. וודא שכתובת האתר שלך (GitHub Pages URL) מוגדרת כדומיין מורשה בפרויקט Firebase (Authentication -> Settings -> Authorized domains).';
                    }
                    setMessage(errorMessage);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="container">
                    <h1>הזדהות</h1>
                    {message && (
                        <div className={`message-box ${message.includes('הצליחה') ? 'success' : ''}`}>
                            {message}
                        </div>
                    )}
                    <div className="button-container">
                        <button className="action-button google" onClick={handleGoogleLogin} disabled={loading}>
                            {loading ? 'מתחבר עם גוגל...' : 'התחבר עם גוגל'}
                        </button>
                    </div>
                    <p style={{marginTop: '20px', fontSize: '0.9em', color: '#888'}}>
                        <strong style={{color: '#d9534f'}}>הערה:</strong> עליך לאפשר
                        Google Sign-in בפרויקט Firebase שלך (Authentication -> Sign-in method)
                        וכן להוסיף את הדומיין של האתר שלך (GitHub Pages URL) לרשימת הדומיינים המורשים
                        (Authentication -> Settings -> Authorized domains).
                    </p>
                </div>
            );
        }

        // Component for the Main Dashboard
        function MainDashboard({ userId, identityId, onGoToForm, onGoToAdmin, onLogout }) {
            return (
                <div className="container">
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                        <h1>ברוך הבא, {identityId || userId}!</h1>
                        <button onClick={onLogout} className="action-button danger" style={{padding: '10px 20px', fontSize: '0.9em'}}>
                            התנתק
                        </button>
                    </div>
                    <p style={{marginBottom: '30px', fontSize: '1.1em', color: '#555'}}>
                        אנא בחר את הפעולה הרצויה:
                    </p>
                    <div className="button-container">
                        <button className="action-button secondary" onClick={onGoToForm}>
                            מילוי טופס חדש
                        </button>
                        <button className="action-button" onClick={onGoToAdmin}>
                            צפייה בכל הנתונים (מנהל)
                        </button>
                    </div>
                    <p style={{marginTop: '20px', fontSize: '0.9em', color: '#888'}}>
                        <strong style={{color: '#d9534f'}}>הערה:</strong> ממשק ה"מנהל" מאפשר לכל משתמש מחובר לצפות בנתונים, בהתאם לכללי האבטחה הנוכחיים של Firestore.
                        כדי להגביל גישה זו למנהלים בלבד, נדרשת הגדרה מתקדמת של הרשאות באמצעות Firebase Cloud Functions בצד השרת.
                    </p>
                </div>
            );
        }


        // Component for the Responsive Form
        function FormComponent({ auth, db, userId, identityId, onLogout, onGoToDashboard }) {
            const [formData, setFormData] = useState({
                familyName: '',
                firstName: '',
                idNumber: '',
                age: '',
                gender: '',
                phone: '',
                address: '',
                residents: '',
                physicalInjury: '',
                casualties: '',
                disconnected: '',
                evacuationAssistance: '',
                notes: '',
            });
            const [message, setMessage] = useState('');
            const [previousSubmissions, setPreviousSubmissions] = useState([]);
            const [loadingSubmissions, setLoadingSubmissions] = useState(true);

            // Function to reset form fields
            const resetForm = () => {
                setFormData({
                    familyName: '', firstName: '', idNumber: '', age: '', gender: '',
                    phone: '', address: '', residents: '', physicalInjury: '',
                    casualties: '', disconnected: '', evacuationAssistance: '', notes: '',
                });
            };

            // Load previous submissions when component mounts or userId changes
            useEffect(() => {
                if (!db || !userId) {
                    console.warn('Firebase Db או userId אינו זמין עבור טעינת נתונים קודמים.');
                    setMessage('שגיאה: Firebase Db אינו מאותחל או שאין מזהה משתמש. אנא וודא את הגדרות Firebase.');
                    setLoadingSubmissions(false);
                    return;
                }

                setLoadingSubmissions(true);
                const appId = window.globalAppId; // Get appId from global variable
                // Construct the user-specific collection path for private data
                const userFormsCollectionRef = window.collectionFirebaseGlobal(db, `artifacts/${appId}/users/${userId}/formData`); // Access from global

                const unsubscribe = window.onSnapshotFirebaseGlobal(userFormsCollectionRef, (snapshot) => { // Access from global
                    const submissions = [];
                    snapshot.forEach(doc => {
                        submissions.push({ id: doc.id, ...doc.data() });
                    });
                    // Sort submissions by a timestamp if available, or just by order of retrieval
                    submissions.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); // Sort by timestamp descending
                    setPreviousSubmissions(submissions);
                    setLoadingSubmissions(false);
                }, (error) => {
                    console.error("Error fetching previous submissions:", error);
                    setMessage(`שגיאה בטעינת נתונים קודמים: ${error.message}. וודא את כללי האבטחה של Firestore.`);
                    setLoadingSubmissions(false);
                });

                // Cleanup subscription on unmount
                return () => unsubscribe();
            }, [userId, db]); // Re-run when userId or db changes

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                if (type === 'radio') {
                    setFormData(prev => ({
                        ...prev,
                        [name]: value
                    }));
                } else {
                    setFormData(prev => ({
                        ...prev,
                        [name]: value
                    }));
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setMessage('');

                if (!db || !userId) {
                    setMessage('שגיאה: Firebase Db אינו מאותחל או שאין מזהה משתמש. אנא התחבר מחדש.');
                    return;
                }

                try {
                    const appId = window.globalAppId; // Get appId from global variable

                    // Data to save to Firestore
                    const dataToSave = {
                        ...formData,
                        userId: userId, // Link data to the Firebase anonymous UID
                        identityId: identityId, // Store the ID entered during "login"
                        timestamp: Date.now() // Add a timestamp for sorting
                    };

                    // Construct the user-specific collection path for private data
                    const userFormsCollectionRef = window.collectionFirebaseGlobal(db, `artifacts/${appId}/users/${userId}/formData`); // Access from global

                    await window.addDocFirebaseGlobal(userFormsCollectionRef, dataToSave); // Access from global
                    setMessage('הנתונים נשמרו בהצלחה!');
                    resetForm(); // Clear the form after successful submission
                } catch (error) {
                    console.error("Error adding document: ", error);
                    setMessage(`שגיאה בשמירת הנתונים: ${error.message}. וודא את כללי האבטחה של Firestore.`);
                }
            };

            const handleLogoutClick = async () => {
                onLogout(); // Trigger logout in parent App component
            }

            return (
                <div className="container">
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                        <h1>מילוי טופס נתונים</h1>
                        <div style={{display: 'flex', gap: '10px'}}>
                            <button onClick={onGoToDashboard} className="action-button secondary" style={{padding: '10px 20px', fontSize: '0.9em'}}>
                                חזור ללוח בקרה
                            </button>
                            <button onClick={handleLogoutClick} className="action-button danger" style={{padding: '10px 20px', fontSize: '0.9em'}}>
                                התנתק
                            </button>
                        </div>
                    </div>

                    <form onSubmit={handleSubmit}>
                        {/* חלק: פרטים אישיים */}
                        <div className="form-section">
                            <div className="form-grid two-columns">
                                <div className="form-group">
                                    <label htmlFor="familyName">שם משפחה:</label>
                                    <input type="text" id="familyName" name="familyName" value={formData.familyName} onChange={handleChange} required placeholder="הזן שם משפחה" />
                                </div>
                                <div className="form-group">
                                    <label htmlFor="firstName">שם פרטי:</label>
                                    <input type="text" id="firstName" name="firstName" value={formData.firstName} onChange={handleChange} required placeholder="הזן שם פרטי" />
                                </div>
                                <div className="form-group">
                                    <label htmlFor="idNumber">תעודת זהות:</label>
                                    <input type="text" id="idNumber" name="idNumber" value={formData.idNumber} onChange={handleChange} pattern="\d{9}" title="יש להזין 9 ספרות" required placeholder="דוגמה: 123456789" />
                                </div>
                                <div className="form-group">
                                    <label htmlFor="age">גיל:</label>
                                    <input type="number" id="age" name="age" value={formData.age} onChange={handleChange} min="0" max="120" placeholder="הזן גיל" />
                                </div>
                                <div className="form-group">
                                    <label htmlFor="gender">מין:</label>
                                    <select id="gender" name="gender" value={formData.gender} onChange={handleChange}>
                                        <option value="">בחר/י</option>
                                        <option value="male">זכר</option>
                                        <option value="female">נקבה</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label htmlFor="phone">טלפון:</label>
                                    <input type="text" id="phone" name="phone" value={formData.phone} onChange={handleChange} pattern="[0-9]{9,10}" title="יש להזין 9 או 10 ספרות" placeholder="דוגמה: 05X-XXXXXXX" />
                                </div>
                                <div className="form-group">
                                    <label htmlFor="address">כתובת:</label>
                                    <input type="text" id="address" name="address" value={formData.address} onChange={handleChange} placeholder="רחוב, מספר, עיר" />
                                </div>
                                <div className="form-group">
                                    <label htmlFor="residents">מספר שוהים בדירה:</label>
                                    <input type="number" id="residents" name="residents" value={formData.residents} onChange={handleChange} min="1" placeholder="כמה נפשות בדירה?" />
                                </div>
                            </div>
                        </div>

                        {/* חלק: פרטי מצב */}
                        <div className="form-section">
                            <div className="form-grid">
                                <div className="form-group">
                                    <label>פציעה פיזית:</label>
                                    <div className="radio-group">
                                        <label><input type="radio" name="physicalInjury" value="none" checked={formData.physicalInjury === 'none'} onChange={handleChange} /> לא (1)</label>
                                        <label><input type="radio" name="physicalInjury" value="light" checked={formData.physicalInjury === 'light'} onChange={handleChange} /> קלה (2)</label>
                                        <label><input type="radio" name="physicalInjury" value="medium" checked={formData.physicalInjury === 'medium'} onChange={handleChange} /> בינונית (3)</label>
                                        <label><input type="radio" name="physicalInjury" value="severe" checked={formData.physicalInjury === 'severe'} onChange={handleChange} /> קשה (4)</label>
                                    </div>
                                </div>
                                <div className="form-group">
                                    <label>הרוגים/פצועים:</label>
                                    <div className="radio-group">
                                        <label><input type="radio" name="casualties" value="no" checked={formData.casualties === 'no'} onChange={handleChange} /> לא</label>
                                        <label><input type="radio" name="casualties" value="yes" checked={formData.casualties === 'yes'} onChange={handleChange} /> כן</label>
                                    </div>
                                </div>
                                <div className="form-group">
                                    <label>מנותקי קשר:</label>
                                    <div className="radio-group">
                                        <label><input type="radio" name="disconnected" value="no" checked={formData.disconnected === 'no'} onChange={handleChange} /> לא</label>
                                        <label><input type="radio" name="disconnected" value="yes" checked={formData.disconnected === 'yes'} onChange={handleChange} /> כן</label>
                                    </div>
                                </div>
                                <div className="form-group">
                                    <label>זקוק לסיוע בפינוי:</label>
                                    <div className="radio-group">
                                        <label><input type="radio" name="evacuationAssistance" value="no" checked={formData.evacuationAssistance === 'no'} onChange={handleChange} /> לא</label>
                                        <label><input type="radio" name="evacuationAssistance" value="yes" checked={formData.evacuationAssistance === 'yes'} onChange={handleChange} /> כן</label>
                                    </div>
                                </div>
                                <div className="form-group" style={{ gridColumn: '1 / -1' }}>
                                    <label htmlFor="notes">הערות:</label>
                                    <textarea id="notes" name="notes" value={formData.notes} onChange={handleChange} placeholder="הוסף הערות רלוונטיות כאן..."></textarea>
                                </div>
                            </div>
                        </div>

                        {/* כפתור שליחה */}
                        {message && (
                            <div className={`message-box ${message.includes('הצלחה') ? 'success' : ''}`}>
                                {message}
                            </div>
                        )}
                        <div className="button-container">
                            <button type="submit" className="action-button">שלח</button>
                        </div>
                    </form>

                    {/* הצגת נתונים קודמים */}
                    <div className="previous-submissions">
                        <h2>נתונים קודמים (מזהה משתמש: {userId})</h2>
                        {loadingSubmissions ? (
                            <p>טוען נתונים...</p>
                        ) : previousSubmissions.length === 0 ? (
                            <p>טרם נשמרו נתונים עבור משתמש זה.</p>
                        ) : (
                            previousSubmissions.map((item, index) => (
                                <div key={item.id} className="submission-item">
                                    <span><strong>תאריך/שעה:</strong> {new Date(item.timestamp).toLocaleString('he-IL')}</span>
                                    <span><strong>מזהה הזדהות:</strong> {item.identityId || 'לא הוזן'}</span>
                                    <span><strong>שם:</strong> {item.firstName} {item.familyName}</span>
                                    <span><strong>גיל:</strong> {item.age}, <strong>מין:</strong> {item.gender}</span>
                                    <span><strong>טלפון:</strong> {item.phone}</span>
                                    <span><strong>כתובת:</strong> {item.address}</span>
                                    <span><strong>מספר שוהים:</strong> {item.residents}</span>
                                    <span><strong>פציעה פיזית:</strong> {item.physicalInjury}</span>
                                    <span><strong>הרוגים/פצועים:</strong> {item.casualties}</span>
                                    <span><strong>מנותקי קשר:</strong> {item.disconnected}</span>
                                    <span><strong>זקוק לסיוע בפינוי:</strong> {item.evacuationAssistance}</span>
                                    <span><strong>הערות:</strong> {item.notes || 'אין'}</span>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        }

        // New Component: Admin View to show all submissions
        function AdminViewComponent({ auth, db, onGoToDashboard }) {
            const [allSubmissions, setAllSubmissions] = useState([]);
            const [loadingAllSubmissions, setLoadingAllSubmissions] = useState(true);
            const [message, setMessage] = useState('');

            useEffect(() => {
                if (!db || !auth) {
                    setMessage('שגיאה: שירותי Firebase Db או Auth אינם זמינים.');
                    setLoadingAllSubmissions(false);
                    return;
                }
                if (!auth.currentUser) {
                    setMessage('שגיאה: אינך מחובר. אנא התחבר כדי לצפות בנתונים.');
                    setLoadingAllSubmissions(false);
                    return;
                }

                setLoadingAllSubmissions(true);
                const queryRef = window.queryFirebaseGlobal(window.collectionGroupFirebaseGlobal(db, 'formData'));

                const unsubscribe = window.onSnapshotFirebaseGlobal(queryRef, (snapshot) => {
                    const submissions = [];
                    snapshot.forEach(doc => {
                        submissions.push({ id: doc.id, ...doc.data() });
                    });
                    // Sort by timestamp if available, descending
                    submissions.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    setAllSubmissions(submissions);
                    setLoadingAllSubmissions(false);
                }, (error) => {
                    console.error("Error fetching all submissions:", error);
                    let errorMessage = `שגיאה באחזור כל הנתונים: ${error.message}.`;
                    if (error.code === 'permission-denied') {
                        errorMessage += " וודא שכללי האבטחה של Firestore מאפשרים קריאה מ-`formData` לכל המשתמשים המחוברים.";
                    }
                    setMessage(errorMessage);
                    setLoadingAllSubmissions(false);
                });

                return () => unsubscribe();
            }, [db, auth]);

            return (
                <div className="container">
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                        <h1>כל הנתונים שהוגשו</h1>
                        <button onClick={onGoToDashboard} className="action-button secondary" style={{padding: '10px 20px', fontSize: '0.9em'}}>
                            חזור ללוח בקרה
                        </button>
                    </div>

                    {message && (
                        <div className={`message-box ${message.includes('הצלחה') ? 'success' : 'danger'}`}>
                            {message}
                        </div>
                    )}

                    {loadingAllSubmissions ? (
                        <p>טוען את כל הנתונים...</p>
                    ) : allSubmissions.length === 0 ? (
                        <p>טרם נשמרו נתונים כלשהם.</p>
                    ) : (
                        <div className="all-submissions-list">
                            {allSubmissions.map((item) => (
                                <div key={item.id} className="submission-item" style={{marginBottom: '20px', borderBottom: '1px solid #eee', paddingBottom: '15px'}}>
                                    <h3 style={{marginTop: '0', color: '#333', fontSize: '1.2em'}}>טופס מזהה: {item.id}</h3>
                                    <span><strong>תאריך/שעה:</strong> {new Date(item.timestamp).toLocaleString('he-IL')}</span>
                                    <span><strong>מזהה משתמש:</strong> {item.userId}</span>
                                    <span><strong>מזהה הזדהות:</strong> {item.identityId || 'לא הוזן'}</span>
                                    <span><strong>שם:</strong> {item.firstName} {item.familyName}</span>
                                    <span><strong>גיל:</strong> {item.age}, <strong>מין:</strong> {item.gender}</span>
                                    <span><strong>טלפון:</strong> {item.phone}</span>
                                    <span><strong>כתובת:</strong> {item.address}</span>
                                    <span><strong>מספר שוהים:</strong> {item.residents}</span>
                                    <span><strong>פציעה פיזית:</strong> {item.physicalInjury}</span>
                                    <span><strong>הרוגים/פצועים:</strong> {item.casualties}</span>
                                    <span><strong>מנותקי קשר:</strong> {item.disconnected}</span>
                                    <span><strong>זקוק לסיוע בפינוי:</strong> {item.evacuationAssistance}</span>
                                    <span><strong>הערות:</strong> {item.notes || 'אין'}</span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }


        // Main App Component to manage login state and render components
        function App() {
            const [firebaseInstances, setFirebaseInstances] = useState({ app: null, auth: null, db: null });
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userUid, setUserUid] = useState(null);
            const [enteredIdentityId, setEnteredIdentityId] = useState(null);
            const [currentView, setCurrentView] = useState('login'); // 'login', 'dashboard', 'form', 'admin'
            const logoutTriggeredRef = useRef(false);

            useEffect(() => {
                // Initialize Firebase only once and ensure global instances are available
                if (!window.firebaseApp || !window.firebaseAuth || !window.firebaseDb) {
                    console.error("Global Firebase instances are not available. Please check the initial script tag for Firebase initialization errors.");
                    setIsAuthReady(true); // Mark ready to display error
                    return;
                }

                // If already initialized in the global script, use those instances
                setFirebaseInstances({
                    app: window.firebaseApp,
                    auth: window.firebaseAuth,
                    db: window.firebaseDb
                });

                const auth = window.firebaseAuth;
                // Set up auth state listener
                const unsubscribe = window.onAuthStateChangedGlobal(auth, async (user) => { // Use global onAuthStateChangedGlobal
                    if (user) {
                        setUserUid(user.uid);
                        let newIdentityId = user.uid;
                        if (user.email) {
                            newIdentityId = user.email;
                        } else if (user.phoneNumber) {
                            newIdentityId = user.phoneNumber;
                        } else if (user.displayName) {
                            newIdentityId = user.displayName;
                        }
                        setEnteredIdentityId(newIdentityId);
                        setIsAuthReady(true);
                        logoutTriggeredRef.current = false;
                        setCurrentView('dashboard'); // Go to dashboard on successful login
                        console.log("User signed in:", user.uid, "Identity:", newIdentityId);
                    } else {
                        setUserUid(null);
                        setEnteredIdentityId(null);
                        setIsAuthReady(true);
                        setCurrentView('login'); // Go to login on logout/no user
                        console.log("User signed out or no user. Auth state processed.");
                    }
                });
                return () => unsubscribe(); // Cleanup listener on unmount
            }, []); // Empty dependency array: run once on mount for initialization

            const handleLoginSuccess = (uid, id) => {
                setUserUid(uid);
                setEnteredIdentityId(id);
                logoutTriggeredRef.current = false;
                setCurrentView('dashboard'); // Navigate to dashboard after login
            };

            const handleLogout = async () => {
                try {
                    if (firebaseInstances.auth) {
                        logoutTriggeredRef.current = true;
                        await window.signOutFirebaseGlobal(firebaseInstances.auth); // Use global signOutFirebaseGlobal
                    } else {
                        console.warn("Firebase Auth is not available for logout.");
                        setUserUid(null);
                        setEnteredIdentityId(null);
                        logoutTriggeredRef.current = true;
                        setCurrentView('login'); // Force login view if Firebase auth is somehow unavailable
                    }
                } catch (error) {
                    console.error("שגיאה בהתנתקות:", error);
                }
            };

            const goToForm = () => setCurrentView('form');
            const goToAdmin = () => setCurrentView('admin');
            const goToDashboard = () => setCurrentView('dashboard');


            // Display loading or error message
            if (!isAuthReady) {
                return (
                    <div className="container">
                        <h1>טוען...</h1>
                        <p>ממתין לאתחול Firebase. אם הודעה זו נשארת זמן רב, ייתכן שיש בעיה בהגדרות Firebase שלך או בחיבור לאינטרנט.</p>
                        <p>אנא בדוק את קונסולת המפתחים (F12) לפרטים נוספים.</p>
                    </div>
                );
            }

            if (!firebaseInstances.auth || !firebaseInstances.db) {
                return (
                    <div className="container">
                        <h1>שגיאה באתחול Firebase!</h1>
                        <p>לא ניתן להתחבר ל-Firebase. אנא וודא שקובץ `firebaseConfig` שלך מוגדר כראוי בפרויקט Firebase שלך ושהדומיין הנוכחי מורשה (Authentication -> Settings -> Authorized domains).</p>
                        <p>פרטים נוספים יכולים להימצא בקונסולת המפתחים של הדפדפן (F12).</p>
                    </div>
                );
            }

            // Render components based on currentView state
            switch (currentView) {
                case 'login':
                    return <LoginPage auth={firebaseInstances.auth} onLoginSuccess={handleLoginSuccess} />;
                case 'dashboard':
                    return (
                        <MainDashboard
                            userId={userUid}
                            identityId={enteredIdentityId}
                            onGoToForm={goToForm}
                            onGoToAdmin={goToAdmin}
                            onLogout={handleLogout}
                        />
                    );
                case 'form':
                    return (
                        <FormComponent
                            auth={firebaseInstances.auth}
                            db={firebaseInstances.db}
                            userId={userUid}
                            identityId={enteredIdentityId}
                            onLogout={handleLogout}
                            onGoToDashboard={goToDashboard}
                        />
                    );
                case 'admin':
                    return (
                        <AdminViewComponent
                            auth={firebaseInstances.auth}
                            db={firebaseInstances.db}
                            onGoToDashboard={goToDashboard}
                        />
                    );
                default:
                    return (
                        <div className="container">
                            <h1>שגיאה: תצוגה לא ידועה</h1>
                            <p>אירעה שגיאה בלתי צפויה במערכת הניווט. אנא רענן את העמוד.</p>
                            <button className="action-button" onClick={() => window.location.reload()}>רענן</button>
                        </div>
                    );
            }
        }

        // Render the App component into the 'root' div
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
